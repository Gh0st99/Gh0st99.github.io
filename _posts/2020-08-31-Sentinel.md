---
layout: post
title:  "Sentinel 分析"
date:   2020-08-31 22:32:47 +0800
categories: Java
---

# Sentinel 分析


## 滑动窗口

### 核心类

![sentinel-class]({{ site.url }}/assets/imgs/sentinel/core-class.png)

{% comment %}
```plantuml 
@startuml 核心类
interface Metric {
    + long success()
    + long exception()
    + long block()
    + long pass()
    + long rt()
    + MetricBucket[] windows()
}

class ArrayMetric {
    - LeapArray<MetricBucket> data
}

Metric <|--- ArrayMetric

abstract class LeapArray<T> {
    # int windowLengthInMs //  = intervalInMs / sampleCount
    # int sampleCount
    # int intervalInMs
    # double intervalInSecond
    # AtomicReferenceArray<WindowWrap<T>> array // len = sampleCount
    - ReentrantLock updateLock

    # abstract T newEmptyBucket(long timeMillis)
    # abstract WindowWrap<T> resetWindowTo(WindowWrap<T> windowWrap, long startTime)
}

ArrayMetric *-- LeapArray

class OccupiableBucketLeapArray {
    FutureBucketLeapArray borrowArray
}

class FutureBucketLeapArray {
}

class BucketLeapArray {
}

LeapArray <|--- OccupiableBucketLeapArray
LeapArray <|--- BucketLeapArray
LeapArray <|--- FutureBucketLeapArray
OccupiableBucketLeapArray *-- FutureBucketLeapArray


class WindowWrap<T> {
    - long windowLengthInMs
    - long windowStart
    - T value
    + WindowWrap<T> resetTo(long startTime)
    + boolean isTimeInWindow(long timeMillis)
}

LeapArray "1" *-- "n" WindowWrap


class MetricBucket {
    - LongAdder[] counters
    - volatile long minRt
}
WindowWrap - MetricBucket: T is >

enum MetricEvent {
    PASS
    BLOCK
    EXCEPTION
    SUCCESS
    RT
    OCCUPIED_PASS
}

MetricBucket - MetricEvent: counters 长度和元素顺序 >
@enduml
```
{% endcomment %}


```java
public ArrayMetric(int sampleCount, int intervalInMs) {
    this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs);
}

public ArrayMetric(int sampleCount, int intervalInMs, boolean enableOccupy) {
    if (enableOccupy) {
        this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs);
    } else {
        this.data = new BucketLeapArray(sampleCount, intervalInMs);
    }
}
```

统计的项有：

- PASS： 通过；
- BLOCK：阻塞；
- EXCEPTION：异常；
- SUCCESS：成功；
- RT：返回时间；
- OCCUPIED_PASS: 占下一个时间窗口通过 (>= 1.5.0)。

这些按照 `MetricEvent` 中定义的顺序存在 `MetricBucket` 中的 `LongAdder[]`。

> `LongAdder` 是个好东西，**cache line, false sharing**。

`MetricBucket` 存在 `WindowWrap` 中，而 `WindowWrap` 定义了：
- 窗口时间长度；
- 窗口的起始时间。

而 `WindowWrap` 以数组的形式存在于 `LeapArray` 中：

- 所有属性在创建 `LeapArray` 时就已经确定；
- 使用 `AtomicReferenceArray` 来帮助 `MetricBucket` 数组的原子性。