---
layout: post
title:  "æŸ¥æ¼è¡¥ç¼ºæ€ç»´å¯¼å›¾"
date:   2021-05-27 13:20:06 +0800
categories: é¢è¯•
---


# æŸ¥æ¼è¡¥ç¼º

## Java
![java]({{ site.url }}/assets/imgs/resume/java.svg)

---

## JVM

![jvm]({{ site.url }}/assets/imgs/resume/jvm.svg)


---

## MySQL


![mysql]({{ site.url }}/assets/imgs/resume/mysql.svg)


![explain]({{ site.url }}/assets/imgs/resume/explain.svg)

![extra]({{ site.url }}/assets/imgs/resume/extra.svg)

---

## Redis

![redis]({{ site.url }}/assets/imgs/resume/redis.svg)

---
## ES

![es]({{ site.url }}/assets/imgs/resume/es.svg)

---
## åˆ†å¸ƒå¼

![distributed]({{ site.url }}/assets/imgs/resume/distributed.svg)

---
## Linux
![linux]({{ site.url }}/assets/imgs/resume/linux.svg)

---

## ç½‘ç»œ
![network]({{ site.url }}/assets/imgs/resume/network.svg)

---

## Spring

![spring]({{ site.url }}/assets/imgs/resume/spring.svg)


---
---
### synchronized
#### åŸç†

`Synchronized` çš„è¯­ä¹‰åº•å±‚æ˜¯é€šè¿‡ä¸€ä¸ª `monitor` çš„å¯¹è±¡æ¥å®Œæˆï¼Œå…¶å® `wait/notify` ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº `monitor` å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨ `wait/notify` ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º **java.lang.IllegalMonitorStateException** çš„å¼‚å¸¸çš„åŸå› ã€‚

- monitorenter & monitorexit
- ACC_SYNCHRONIZED 

![sync-markword]({{ site.url }}/assets/imgs/resume/sync-markword.png)

æœºåˆ¶ä¸ `AQS` æ˜¯å¾ˆç›¸ä¼¼çš„ï¼Œåªä¸è¿‡ `AQS` ä¸­æ˜¯ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å¤šä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚

![sync-flow]({{ site.url }}/assets/imgs/resume/sync-flow.png)

##### ç»“æ„
```c++
ObjectMonitor() {
    _header       = NULL;
    _count        = 0;
    _waiters      = 0,       // ç­‰å¾…ä¸­çš„çº¿ç¨‹æ•°
    _recursions   = 0;       // çº¿ç¨‹é‡å…¥æ¬¡æ•°
    _object       = NULL;    // å­˜å‚¨è¯¥ monitor çš„å¯¹è±¡
    _owner        = NULL;    // æŒ‡å‘æ‹¥æœ‰è¯¥ monitor çš„çº¿ç¨‹
    _WaitSet      = NULL;    // ç­‰å¾…çº¿ç¨‹ åŒå‘å¾ªç¯é“¾è¡¨_WaitSet æŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    _WaitSetLock  = 0 ;
    _Responsible  = NULL ;
    _succ         = NULL ;
    _cxq          = NULL ;   // å¤šçº¿ç¨‹ç«äº‰é”æ—¶çš„å•å‘é“¾è¡¨
    FreeNext      = NULL ;
    _EntryList    = NULL ;   // _owner ä»è¯¥åŒå‘å¾ªç¯é“¾è¡¨ä¸­å”¤é†’çº¿ç¨‹ï¼Œ
    _SpinFreq     = 0 ;
    _SpinClock    = 0 ;
    OwnerIsThread = 0 ;
    _previous_owner_tid = 0; // å‰ä¸€ä¸ªæ‹¥æœ‰æ­¤ç›‘è§†å™¨çš„çº¿ç¨‹ ID
  }
```
- `_owner`ï¼šåˆå§‹æ—¶ä¸º `NULL`ã€‚å½“æœ‰çº¿ç¨‹å æœ‰è¯¥ `monitor` æ—¶ `owner` æ ‡è®°ä¸ºè¯¥çº¿ç¨‹çš„ `ID`ã€‚å½“çº¿ç¨‹é‡Šæ”¾ `monitor` æ—¶ `owner` æ¢å¤ä¸º `NULL`ã€‚`owner` æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æº `JVM` æ˜¯é€šè¿‡ `CAS` æ“ä½œæ¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨çš„ã€‚
- `_cxq`ï¼šç«äº‰é˜Ÿåˆ—æ‰€æœ‰è¯·æ±‚é”çš„çº¿ç¨‹é¦–å…ˆä¼šè¢«æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼ˆå•å‘ï¼‰ã€‚`_cxq` æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æº `JVM` é€šè¿‡ `CAS` åŸå­æŒ‡ä»¤æ¥ä¿®æ”¹ `_cxq` é˜Ÿåˆ—ã€‚
    - æ¯å½“æœ‰æ–°æ¥çš„èŠ‚ç‚¹å…¥é˜Ÿï¼Œå®ƒçš„ `next` æŒ‡é’ˆæ€»æ˜¯æŒ‡å‘ä¹‹å‰é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œè€Œ `_cxq` æŒ‡é’ˆä¼šæŒ‡å‘è¯¥æ–°å…¥é˜Ÿçš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ˜¯åæ¥å±…ä¸Šã€‚
- `_EntryList`ï¼š `_cxq` é˜Ÿåˆ—ä¸­**æœ‰èµ„æ ¼æˆä¸ºå€™é€‰èµ„æºçš„çº¿ç¨‹**ä¼šè¢«ç§»åŠ¨åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚
- `_WaitSet`: ç­‰å¾…é˜Ÿåˆ—å› ä¸ºè°ƒç”¨ `wait` æ–¹æ³•è€Œ**è¢«é˜»å¡**çš„çº¿ç¨‹ä¼šè¢«æ”¾åœ¨è¯¥é˜Ÿåˆ—ä¸­ã€‚

##### ç«äº‰

- é€šè¿‡ `CAS` å°è¯•æŠŠ `monitor` çš„ `owner` å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚
- å¦‚æœè®¾ç½®ä¹‹å‰çš„ `owner` **æŒ‡å‘å½“å‰çº¿ç¨‹**ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹**å†æ¬¡è¿›å…¥** `monitor`ï¼Œå³é‡å…¥é”æ‰§è¡Œ `recursions++` , è®°å½•é‡å…¥çš„æ¬¡æ•°ã€‚(**å¯é‡å…¥æ€§**)
- å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¯¥ `monitor`, è®¾ç½® `recursions` ä¸º 1, `_owner` ä¸º**å½“å‰çº¿ç¨‹**ï¼Œè¯¥çº¿ç¨‹æˆåŠŸè·å¾—é”å¹¶è¿”å›ã€‚
- å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™**ç­‰å¾…**é”çš„é‡Šæ”¾ã€‚

##### ç­‰å¾…

- å½“å‰çº¿ç¨‹è¢«å°è£…æˆ `ObjectWaiter` å¯¹è±¡ `node`ï¼ŒçŠ¶æ€è®¾ç½®æˆ `ObjectWaiter::TS_CXQã€‚
- `for` å¾ªç¯é€šè¿‡ `CAS` æŠŠ `node` èŠ‚ç‚¹ push åˆ° `_cxq` åˆ—è¡¨ä¸­ï¼ŒåŒä¸€æ—¶åˆ»å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹æŠŠè‡ªå·±çš„ `node` èŠ‚ç‚¹ push åˆ° `_cxq` åˆ—è¡¨ä¸­ã€‚
- `node` èŠ‚ç‚¹ push åˆ° `_cxq` åˆ—è¡¨ä¹‹åï¼Œé€šè¿‡**è‡ªæ—‹**å°è¯•è·å–é”ï¼Œå¦‚æœè¿˜æ˜¯**æ²¡æœ‰è·å–åˆ°é”**åˆ™é€šè¿‡ `park` å°†å½“å‰çº¿ç¨‹**æŒ‚èµ·ç­‰å¾…è¢«å”¤é†’**ã€‚
- å½“è¯¥çº¿ç¨‹**è¢«å”¤é†’**æ—¶ä¼šä»æŒ‚èµ·çš„ç‚¹ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡ `ObjectMonitor::TryLock` **å°è¯•è·å–é”**ã€‚

##### é‡Šæ”¾

å½“æŸä¸ªæŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼š**é‡Šæ”¾é”**å¹¶ `unpark` **åç»­çº¿ç¨‹**ã€‚

##### notify

`notify` æˆ–è€… `notifyAll` æ–¹æ³•å¯ä»¥**å”¤é†’åŒä¸€ä¸ªé”ç›‘è§†å™¨ä¸‹è°ƒç”¨ wait æŒ‚èµ·çš„çº¿ç¨‹**ï¼Œå°†å…¶æ”¾å…¥ `_EntryList`ã€‚


---

### çº¿ç¨‹æ± 

#### çº¿ç¨‹è·å–ä»»åŠ¡

`getTask()`

![threadpool-gettask]({{ site.url }}/assets/imgs/resume/threadpool-gettask.jpg)

èµ°ğŸ‘ˆğŸ»çš„æ˜¯ä¸å¯å›æ”¶çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œèµ°ğŸ‘‰ğŸ»çš„æ˜¯é™ keepalive æ—¶é—´ï¼Œéæ ¸å¿ƒçº¿ç¨‹ + å¯å›æ”¶çš„æ ¸å¿ƒçº¿ç¨‹ã€‚

å¦‚æœè¿”å›çš„æ˜¯ `null`ï¼Œåˆ™å°† `ctl` cas(-1)ã€‚

è°ƒç”¨ `processWorkerExit` æ¸…ç†çº¿ç¨‹ã€‚

è·å–ä»»åŠ¡ä¸ä¸º nullï¼Œä¼šä¸Šè‡ªå·±çš„ä¸€æŠŠé”æ‰§è¡Œä»»åŠ¡ã€‚

#### å‚æ•°åŠ¨æ€åŒ–

##### setCorePoolSize

![threadpool-setcoresize]({{ site.url }}/assets/imgs/resume/threadpool-setcoresize.jpg)

##### setKeepAliveTime

å¦‚æœæ—¶é—´æ”¹å°ï¼Œåˆ™ `interruptIdleWorkers`ã€‚

```java
final ReentrantLock mainLock = this.mainLock;
mainLock.lock();
try {
    for (Worker w : workers) {
        Thread t = w.thread;
        // å°è¯•è·å¾—é”æˆåŠŸï¼Œåˆ™è¡¨æ˜å…¶ç©ºé—²
        if (!t.isInterrupted() && w.tryLock()) {
            try {
                t.interrupt();
            } catch (SecurityException ignore) {
            } finally {
                w.unlock();
            }
        }
        if (onlyOne)
            break;
    }
} finally {
    mainLock.unlock();
}
```

##### setMaximumPoolSize

`interruptIdleWorkers`ã€‚

#### å¼‚å¸¸å¤„ç†

##### submit

```java
public Future<?> submit(Runnable task) {
    if (task == null) throw new NullPointerException();
    RunnableFuture<Void> ftask = newTaskFor(task, null);
    execute(ftask);
    return ftask;
}

protected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {
    return new FutureTask<T>(callable);
}

// FutureTask::run
public void run() {
    // ...
    try {
        Callable<V> c = callable;
        if (c != null && state == NEW) {
            V result;
            boolean ran;
            try {
                result = c.call();
                ran = true;
            } catch (Throwable ex) {
                result = null;
                ran = false;
                // ç”Ÿåäº†å¼‚å¸¸
                setException(ex);
            }
            if (ran)
                set(result);
        }
    } finally {
        // ...
    }
}
// FutureTask::setException
protected void setException(Throwable t) {
    if (STATE.compareAndSet(this, NEW, COMPLETING)) {
        // å°†å¼‚å¸¸è®¾ç½®ä¸ºç»“æœ
        outcome = t;
        STATE.setRelease(this, EXCEPTIONAL); // final state
        finishCompletion();
    }
}

private V report(int s) throws ExecutionException {
    Object x = outcome;
    if (s == NORMAL)
        return (V)x;
    if (s >= CANCELLED)
        throw new CancellationException();
    // æŠ›å‡ºå¼‚å¸¸
    throw new ExecutionException((Throwable)x);
}

public V get() throws InterruptedException, ExecutionException {
    int s = state;
    if (s <= COMPLETING)
        s = awaitDone(false, 0L);
    // è·å¾—ç»“æœ
    return report(s);
}
```

åªæœ‰åœ¨ `get()` æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚


##### execute

ä»»åŠ¡éƒ½æ˜¯ç”± `Worker` æ‰§è¡Œã€‚

```java
private final class Worker extends AbstractQueuedSynchronizer implements Runnable {
    public void run() {
        runWorker(this);
    }

    final void runWorker(Worker w) {
        Thread wt = Thread.currentThread();
        Runnable task = w.firstTask;
        w.firstTask = null;
        w.unlock(); // allow interrupts
        boolean completedAbruptly = true;
        try {
            while (task != null || (task = getTask()) != null) {
                w.lock();
                // If pool is stopping, ensure thread is interrupted;
                // if not, ensure thread is not interrupted.  This
                // requires a recheck in second case to deal with
                // shutdownNow race while clearing interrupt
                if ((runStateAtLeast(ctl.get(), STOP) ||
                     (Thread.interrupted() &&
                      runStateAtLeast(ctl.get(), STOP))) &&
                    !wt.isInterrupted())
                    wt.interrupt();
                try {
                    beforeExecute(wt, task);
                    try {
                        task.run();
                        afterExecute(task, null);
                    } catch (Throwable ex) {
                        // é‡åˆ°å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸
                        afterExecute(task, ex);
                        throw ex;
                    }
                } finally {
                    task = null;
                    w.completedTasks++;
                    w.unlock();
                }
            }
            completedAbruptly = false;
        } finally {
            processWorkerExit(w, completedAbruptly);
        }
    }
}
```
---

### Redis Cluster

#### å…¥é—¨

- `6379` æœåŠ¡å®¢æˆ·ç«¯ï¼›
- `16379` cluster busï¼ŒèŠ‚ç‚¹é—´é€šä¿¡çš„äºŒè¿›åˆ¶é€šé“ï¼›
  - æ•…éšœæ£€æµ‹
  - é…ç½®æ›´æ–°
  - æ•…éšœè½¬ç§»æˆæƒ

ä¸ä½¿ç”¨ä¸€è‡´æ€§ hashï¼Œä½¿ç”¨ `hash slot`ã€‚æœ‰ `16384 slot`ï¼Œ`CRC16(key) mod 16384` æ¥åˆ†é…ã€‚e.g.

- Node A contains hash slots from 0 to 5500.
- Node B contains hash slots from 5501 to 11000.
- Node C contains hash slots from 11001 to 16383.

å¢åˆ èŠ‚ç‚¹ï¼š
- å‡å¦‚è¦ + Dï¼Œå°±æŠŠ Aï¼ŒBï¼ŒC ä¸­çš„ä¸€äº› `hash slot`
- å‡å¦‚è¦ - Aï¼Œå°±æŠŠ A ä¸­çš„ `hash slot` ç§»åŠ¨å•ŠBï¼ŒC ä¸­

**hash tag**

`this{foo}` å’Œ `another{foo}` åœ¨ä¸€ä¸ª `hash slot` ä¸­ï¼Œå¯ä»¥åœ¨ä¸€æ¡å‘½ä»¤ä¸­æ‰§è¡Œå¤šé”®æ“ä½œã€‚**æ ¸å¿ƒç½‘ç»œæ¨¡å‹**

**master slave**

`A` & `B` & `C` æ¯ä¸ªå¢åŠ ä¸€ä¸ª `slave` èŠ‚ç‚¹ã€‚

`B` GG åï¼Œ `B1` è¢«é€‰ä¸¾æ–°çš„ `master`ã€‚

**ä¸€è‡´æ€§ä¿è¯****æ ¸å¿ƒç½‘ç»œæ¨¡å‹**

ç‰¹å®šæƒ…å†µä¸‹ï¼Œå¯èƒ½å›ä¸¢å¤±ç³»ç»Ÿå‘å®¢æˆ·ç«¯ç¡®è®¤çš„å†™å…¥ã€‚

åŸå› æ˜¯ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼š
- å®¢æˆ·ç«¯å†™å…¥ master B;
- master B å›å¤ OK;
- master B ä¼ æ’­å†™åˆ° B1, B2, B3ã€‚

ä¸¢å¤±æ•°æ®å¯èƒ½ï¼š
1. å‡å¦‚ï¼Œmaster B å›å¤åï¼Œ gg äº†ï¼Œè¿˜æ²¡æ¥å¾—åŠä¼ æ’­ï¼ŒB1 å½“é€‰ï¼Œå°±ä¸¢å¤±äº†å†™æ•°æ®ã€‚

> å¦‚åŒå…¶ä»–æ•°æ®åº“ï¼Œæ¯ s åŒæ­¥åˆ°ç¡¬ç›˜ä¸€æ ·ã€‚å¯å¼ºåˆ¶åŒæ­¥å¤åˆ¶ã€å†™(**WAIT**)ï¼Œä½†æ˜¯å›é™ä½æ€§èƒ½ã€‚å³ä½¿åŒæ­¥å†™ä¹Ÿä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ã€‚

2.  ç½‘ç»œåˆ†åŒºï¼ŒB å’Œ å®¢æˆ·ç«¯ Z1 ä¸å…¶ä»–åˆ†åŒºäº†ã€‚Z1 èƒ½å†™å…¥ Bã€‚å¦‚æœåˆ†åŒºæŒç»­è¶³å¤Ÿä¹…æ—¶é—´è®© B1 åœ¨åˆ†åŒºçš„å¤šæ•°ä¾§æå‡ä¸º masterï¼Œåˆ™ Z1 åŒæ—¶å‘é€ç»™ B çš„å†™å…¥å°†ä¸¢å¤±ã€‚

> **node timeout**: Z1 èƒ½å¤Ÿå‘é€åˆ° B çš„å†™å…¥é‡æœ‰ä¸€ä¸ª max windowï¼šå¦‚æœåˆ†åŒºçš„å¤šæ•°ä¾§å·²ç»æœ‰è¶³å¤Ÿçš„æ—¶é—´æ¥é€‰ä¸¾ä¸€ä¸ª slaveä½œä¸º masterï¼Œé‚£ä¹ˆå°‘æ•°ä¾§çš„æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½å°†åœæ­¢æ¥å—å†™å…¥

- åœ¨ç»è¿‡ `node timeout` ä¹‹åï¼Œä¸€ä¸ª `master node` è¢«è®¤ä¸º `failing`ï¼Œå¯ä»¥è¢«å…¶å¤åˆ¶èŠ‚ç‚¹å–ä»£ï¼›
- åœ¨èŠ‚ç‚¹è¶…æ—¶è¿‡åï¼Œä¸»èŠ‚ç‚¹æ— æ³•æ„ŸçŸ¥å¤§å¤šæ•°å…¶ä»–ä¸»èŠ‚ç‚¹ï¼Œå®ƒä¼šè¿›å…¥é”™è¯¯çŠ¶æ€å¹¶åœæ­¢æ¥å—å†™å…¥ã€‚

#### è§„èŒƒ

##### ç›®æ ‡

- 1000 èŠ‚ç‚¹ä¸‹é«˜æ€§èƒ½ï¼›
- å¯æ¥å—çš„å†™å®‰å…¨ï¼Œæœ€å¤§é™åº¦çš„ä¿ç•™å®¢æˆ·ç«¯åœ¨å¤§å¤šæ•°èŠ‚ç‚¹çš„å†™å…¥ï¼›
- å¯ç”¨æ€§ï¼šèƒ½åœ¨å¤§å¤šæ•°èŠ‚ç‚¹å¯è®¿é—®çš„åˆ†åŒºä¸­å­˜æ´»ä¸‹æ¥ã€‚

##### å®ç°çš„å­é›†

- æ‰€æœ‰çš„å• key å‘½ä»¤ï¼›
- éƒ¨åˆ†å¤š key å‘½ä»¤ï¼›
- hash tag
- åªæœ‰ db0ï¼Œä¸èƒ½ selectã€‚

##### å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ‰®æ¼”çš„è§’è‰²

**è´£ä»»**
- å­˜æ•°æ®ï¼›**æ ¸å¿ƒç½‘ç»œæ¨¡å‹**
    - å®¢æˆ·ç«¯æŒæœ‰ `key` -> `Node` çš„æ˜ å°„èƒ½å¢åŠ æ€§èƒ½
- è‡ªåŠ¨å‘ç°å…¶ä»–èŠ‚ç‚¹ï¼›
  - gossip åè®®
- å‘ç°ä¸å·¥ä½œçš„èŠ‚ç‚¹ï¼›
  - å‘ ping åŒ…
- å½“ failer å‘ç”Ÿæ—¶ï¼Œæå‡ slave -> master

**Redis Bus**
ä¸ºäº†è¾¾åˆ°ä¸Šé¢ç›®æ ‡ï¼Œæ¯ä¸ªèŠ‚ç‚¹é€šè¿‡ä¸€ä¸ª**äºŒè¿›åˆ¶**çš„ TCP åè®®è¿æ¥æ¥ä¼ é€’ä¿¡æ¯ã€‚


##### å†™å®‰å…¨

- å¼‚æ­¥å¤åˆ¶ï¼›
- æœ€åæ•…éšœè½¬ç§»è·èƒœã€‚

ç›¸è¾ƒäºè¾ƒå°‘æ•°çš„ç«¯ï¼ŒåŠªåŠ›ä¿ç•™å®¢æˆ·å¯¹äºå¤§å¤šæ•°ç«¯çš„èŠ‚ç‚¹çš„å†™å…¥ã€‚

ä¸¢æ•°æ®çš„æƒ…å†µï¼š
1. master æ¥æ”¶å†™ï¼Œè¿”å› OKï¼Œæ²¡æœ‰ä¼ æ’­ç»™ slaveï¼Œunreachable ç›´åˆ° slave è¢«æ¨ä¸¾ã€‚
2. master å˜åˆ†åŒºï¼Œslave è¢«æ¨ä¸¾ï¼Œmaster å›å½’ï¼Œå®¢æˆ·ç«¯æœªæ›´æ–°è·¯ç”±å†™å…¥è¿™ä¸ª masterã€‚
   - ä¸å¤ªä¼šå‘ç”Ÿï¼Œå› ä¸ºå›å½’äº†ï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…ä¸ä¼šæ¥æ”¶å†™å…¥ã€‚

è¾ƒå°‘ç«¯çš„èŠ‚ç‚¹åœ¨ `NODE_TIMEOUT` åæ‹’ç»å†™å…¥ã€‚


##### å¯ç”¨æ€§

`replcas migration`ã€‚

`1-(1/(N*2-1))` æ¦‚ç‡æ¯ä¸ª `master` æœ‰ä¸€ä¸ª `slave`ã€‚

##### æ€§èƒ½

ä¸æ˜¯ä»£ç†å‘½ä»¤åˆ°æ­£ç¡®çš„ nodeï¼Œredirect å®¢æˆ·ç«¯åˆ°æ­£ç¡®çš„ nodeã€‚

#### ä¸»è¦ç»„ä»¶

##### key åˆ†å¸ƒæ¨¡å¼

`key` ç©ºé—´åˆ†å‰²ä¸º `16384 ä¸ª slot`ã€‚

`CRC16` å 16bit å– 14 ä¸ªï¼Œè€Œ 16384 = 2^14ã€‚

ä¸ºä»€ä¹ˆé€‰ 14ä½ï¼Ÿ

##### node å±æ€§

- å”¯ä¸€çš„ `name`ã€‚`160 bit` éšæœºå­—ç¬¦ä¸²ç”¨ `hex` è¡¨ç¤ºï¼›
- ip & port
- flags
  - pinged æœ€åæ—¶é—´
  - æ¥æ”¶ pong æœ€åæ—¶é—´
  - master æ˜¯è°

#### Nodes æ¡æ‰‹

#### Redirection and resharding

##### MVOED
```
GET x
-MOVED 3999 127.0.0.1:6381
```
è¿”å›çš„æ˜¯ `hash slot` ä»¥åŠè°æŒæœ‰


##### ASK


#### å®¹é”™æ€§

##### å¿ƒè·³å’Œ gossip æ¶ˆæ¯

heartbeat:
- ping
- pong
- ä¸¤ä¸ªéƒ½åŒ…å«é‡è¦çš„é…ç½®ä¿¡æ¯
- æ¯ç§’å‘ ping ç»™æ’å®šæ•°é‡çš„éšæœºèŠ‚ç‚¹ï¼›
- æ¯ä¸ªèŠ‚ç‚¹éƒ½ç¡®ä¿ ping æœªå‘é€ ping æˆ–æ¥æ”¶åˆ° pong çš„æ—¶é—´è¶…è¿‡ NODE_TIMEOUT æ—¶é—´ä¸€åŠçš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚

> å‡è®¾ 100 ä¸ªèŠ‚ç‚¹ï¼Œ 60s è¶…æ—¶ã€‚æ¯ 30s å‘ 99 ä¸ª pingã€‚æ€»å…± 330 ping/s

å¿ƒè·³åŒ…å†…å®¹
- Node IDï¼›
- currentEpoch & configEpoch
- node flagsï¼Œè¡¨æ˜æ˜¯ slaveã€master å’Œå…¶ä»–å•å­—èŠ‚çš„èŠ‚ç‚¹ä¿¡æ¯ï¼›
- å‘é€èŠ‚ç‚¹çš„ hash slot çš„ä½å›¾ï¼›å¦‚æœæ˜¯ä»èŠ‚ç‚¹ï¼Œå°±ä¸»èŠ‚ç‚¹çš„ä½å›¾ï¼›
- å‘é€è€… BASE TCP ç«¯å£ï¼›
- å‘é€è€…è§†è§’çš„é›†ç¾¤çŠ¶æ€
- å¦‚æœæ˜¯ slaveï¼Œå…¶ master 

---

### åˆ†å¸ƒå¼é”

#### æœ€ç®€å• 

```
SETNX lock 1
```

- ç¨‹åºå¤„ç†ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ï¼Œæ²¡åŠæ—¶é‡Šæ”¾é”
- è¿›ç¨‹æŒ‚äº†ï¼Œæ²¡æœºä¼šé‡Šæ”¾é”

#### è®¾ç½®ç§ŸæœŸ

```
SET lock 1 EX 10 NX
```

- é”è¿‡æœŸï¼šå®¢æˆ·ç«¯ 1 æ“ä½œå…±äº«èµ„æºè€—æ—¶å¤ªä¹…ï¼Œå¯¼è‡´é”è¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œä¹‹åè¢«å®¢æˆ·ç«¯ 2 æŒæœ‰
> å¯èƒ½è¯„ä¼°æ“ä½œå…±äº«èµ„æºçš„æ—¶é—´ä¸å‡†ç¡®å¯¼è‡´çš„
- é‡Šæ”¾åˆ«äººçš„é”ï¼šå®¢æˆ·ç«¯ 1 æ“ä½œå…±äº«èµ„æºå®Œæˆåï¼Œå´åˆé‡Šæ”¾äº†å®¢æˆ·ç«¯ 2 çš„é”
> ä¸€ä¸ªå®¢æˆ·ç«¯é‡Šæ”¾äº†å…¶å®ƒå®¢æˆ·ç«¯æŒæœ‰çš„é”

#### è§£å†³é”è¢«åˆ«äººé‡Šæ”¾

```
// åŠ é”ï¼Œä½¿ç”¨ UUID 
SET lock $uuid EX 20 NX

// åˆ¤æ–­é”æ˜¯è‡ªå·±çš„ï¼Œæ‰é‡Šæ”¾
if redis.call("GET",KEYS[1]) == ARGV[1]
then
    return redis.call("DEL",KEYS[1])
else
    return 0
end
```

#### è§£å†³é”è¿‡æœŸæ—¶é—´ä¸å¥½è¯„ä¼°

watchdog

#### ä»å­˜åœ¨çš„é—®é¢˜

`ä¸»ä»é›†ç¾¤ + å“¨å…µ`,ä¸»åº“å®•æœºï¼Œä»åº“è‡ªåŠ¨æå‡ä¸ºä¸»åº“ã€‚ä¸»ä»åˆ‡æ¢æ—¶ï¼Œè¿™ä¸ªåˆ†å¸ƒå¼é”ä¸å®‰å…¨ã€‚

#### æ€»ç»“

- **æ­»é”**ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´
- **è¿‡æœŸæ—¶é—´è¯„ä¼°ä¸å¥½ï¼Œé”æå‰è¿‡æœŸ**ï¼šå®ˆæŠ¤çº¿ç¨‹ï¼Œè‡ªåŠ¨ç»­æœŸ
- **é”è¢«åˆ«äººé‡Šæ”¾**ï¼šé”å†™å…¥å”¯ä¸€æ ‡è¯†ï¼Œé‡Šæ”¾é”å…ˆæ£€æŸ¥æ ‡è¯†ï¼Œå†é‡Šæ”¾

---

### RedLock

1. å®¢æˆ·ç«¯å…ˆè·å–ã€Œå½“å‰æ—¶é—´æˆ³T1ã€
2. å®¢æˆ·ç«¯ä¾æ¬¡å‘è¿™ 5 ä¸ª Redis å®ä¾‹å‘èµ·**åŠ é”è¯·æ±‚**ï¼ˆç”¨å‰é¢è®²åˆ°çš„ `SET` å‘½ä»¤ï¼‰ï¼Œä¸”**æ¯ä¸ªè¯·æ±‚**ä¼š**è®¾ç½®è¶…æ—¶æ—¶é—´**ï¼ˆæ¯«ç§’çº§ï¼Œè¦è¿œå°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå¦‚æœæŸä¸€ä¸ªå®ä¾‹åŠ é”å¤±è´¥ï¼ˆåŒ…æ‹¬ç½‘ç»œè¶…æ—¶ã€é”è¢«å…¶å®ƒäººæŒæœ‰ç­‰å„ç§å¼‚å¸¸æƒ…å†µï¼‰ï¼Œå°±ç«‹å³å‘ä¸‹ä¸€ä¸ª Redis å®ä¾‹ç”³è¯·åŠ é”
3. å¦‚æœå®¢æˆ·ç«¯ä» >=3 ä¸ªï¼ˆ**å¤§å¤šæ•°**ï¼‰ä»¥ä¸Š Redis å®ä¾‹**åŠ é”æˆåŠŸ**ï¼Œåˆ™å†æ¬¡è·å–ã€Œå½“å‰æ—¶é—´æˆ³T2ã€ï¼Œå¦‚æœ `T2 - T1 < é”çš„è¿‡æœŸæ—¶é—´`ï¼Œæ­¤æ—¶ï¼Œè®¤ä¸ºå®¢æˆ·ç«¯**åŠ é”æˆåŠŸ**ï¼Œå¦åˆ™è®¤ä¸ºåŠ é”å¤±è´¥
4. åŠ é”**æˆåŠŸ**ï¼Œå»æ“ä½œå…±äº«èµ„æº
5. åŠ é”**å¤±è´¥**ï¼Œå‘ã€Œå…¨éƒ¨èŠ‚ç‚¹ã€å‘èµ·**é‡Šæ”¾é”è¯·æ±‚**ï¼ˆå‰é¢è®²åˆ°çš„ Lua è„šæœ¬é‡Šæ”¾é”ï¼‰

---

### Redis çº¿ç¨‹æ¨¡å‹

#### å•çº¿ç¨‹äº‹ä»¶å¾ªç¯

Redis 6.0- **æ ¸å¿ƒç½‘ç»œæ¨¡å‹**æ˜¯**å• Reactor**ã€‚

![redis-thread]({{ site.url }}/assets/imgs/resume/redis-thread.jpg)

- client:
  - *conn: socket æŒ‡é’ˆï¼›
  - *db: é€‰æ‹©çš„æ•°æ®åº“ï¼›
  - querybuf: è¯»å…¥ç¼“å†²åŒºï¼›
  - buf: å†™å‡ºç¼“å†²åŒºï¼›
  - reply: å†™å‡ºæ•°æ®é“¾è¡¨ï¼›
- aeApiPoll:  Event Loop çš„æ ¸å¿ƒå‡½æ•°ï¼Œç›‘å¬ç­‰å¾…è¯»å†™æ•°æ®è§¦å‘
- acceptTcpHandler: **è¿æ¥åº”ç­”å¤„ç†å™¨**ã€‚ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ `accept` **æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„æ–°è¿æ¥**ï¼Œä¸ºæ–°è¿æ¥æ³¨å†Œç»‘å®š `readQueryFromClient`ï¼Œä»¥å¤‡åç»­å®¢æˆ·ç«¯ `TCP` è¿æ¥ï¼›
- readQueryFromClient: **å‘½ä»¤è¯»å–å¤„ç†å™¨**ï¼Œè§£æå¹¶æ‰§è¡Œå®¢æˆ·ç«¯çš„è¯·æ±‚å‘½ä»¤
- beforeSleep: 
- sendReplyToClient: **å‘½ä»¤å›å¤å¤„ç†å™¨**ï¼Œå½“ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¹‹åå†™å‡ºç¼“å†²åŒºä¸­è¿˜æœ‰æ•°æ®æ®‹ç•™ï¼Œåˆ™è¿™ä¸ªå¤„ç†å™¨ä¼šè¢«æ³¨å†Œç»‘å®šåˆ°ç›¸åº”çš„è¿æ¥ä¸Šï¼Œç­‰è¿æ¥è§¦å‘å†™å°±ç»ªäº‹ä»¶æ—¶ï¼Œå®ƒä¼šå°†å†™å‡ºç¼“å†²åŒºå‰©ä½™çš„æ•°æ®å›å†™åˆ°å®¢æˆ·ç«¯ã€‚

å·¥ä½œåŸç†ï¼š
- å¯åŠ¨ï¼Œå¼€å¯ `Event Loop`ï¼Œæ³¨å†Œ `acceptTcpHandler` åˆ°ç«¯å£å¯¹åº”çš„ `fd`ï¼Œ**ç­‰å¾…æ–°è¿æ¥åˆ°æ¥**ï¼›
- å®¢æˆ·ç«¯ & æœåŠ¡ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼›
- `acceptTcpHandler` è¢«è°ƒç”¨ï¼Œä¸»çº¿ç¨‹ä½¿ç”¨ `AE` çš„ `API` å°† `readQueryFromClient` ç»‘å®šåˆ°æ–°è¿æ¥çš„ `fd`ï¼Œåˆå§‹åŒ–ä¸€ä¸ª `client` ç»‘å®šè¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼›
- c -> r å‘é€è¯·æ±‚å‘½ä»¤ï¼Œè§¦å‘è¯»å°±ç»ªäº‹ä»¶ï¼Œä¸»çº¿ç¨‹è°ƒç”¨ `readQueryFromClient` è¯»å–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤å­˜å…¥ `client->querybuf`ï¼›
- è°ƒç”¨ `processInputBuffer`ï¼Œå…¶ä¸­è°ƒç”¨ `processInlineBuffer/processMultibulkBuffer` è§£æå‘½ä»¤ï¼Œæœ€åè°ƒç”¨ `processCommand` æ‰§è¡Œå‘½ä»¤ï¼›
- æ ¹æ®è¯·æ±‚å‘½ä»¤çš„ç±»å‹ï¼Œåˆ†é…ç›¸åº”çš„**å‘½ä»¤æ‰§è¡Œå™¨**æ‰§è¡Œï¼Œæœ€åè°ƒç”¨ `addReply` å°†å“åº”å†™å…¥ `client->buf`ï¼ˆ16KBï¼‰ / `client->reply`ï¼ˆå‰é¢çš„ä¸å¤Ÿï¼Œè‡ªåŠ¨åˆ‡æ¢è‡³æ­¤é“¾è¡¨ï¼‰,æœ€åæŠŠ `client` æ·»åŠ åˆ° `clients_pending_write` LIFO é˜Ÿåˆ—ï¼›
- `EventLoop` ä¸»çº¿ç¨‹æ‰§è¡Œ `beforeSleep --> handleClientsWithPendingWrites` éå† `clients_pending_write` è°ƒç”¨ `writeToClient` æŠŠç¼“å†²æ•°æ®å†™é“å®¢æˆ·ç«¯ï¼Œå¦‚æœè¿˜æœ‰æ•°æ®ï¼Œæ³¨å†Œ `sendReplyToClient` åˆ°å†™å°±ç»ªäº‹ä»¶ï¼Œ

#### å¤šçº¿ç¨‹å¼‚æ­¥ä»»åŠ¡

Redis 4.0+

è€—æ—¶çš„æ“ä½œå¼‚æ­¥åŒ–ï¼Œé¿å…é˜»å¡å•çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ã€‚

![redis-async]({{ site.url }}/assets/imgs/resume/redis-async.jpg)

- `UNLINK`: `del` å¼‚æ­¥ç‰ˆæœ¬ï¼Œä¸ä¼šåŒæ­¥åˆ é™¤æ•°æ®ï¼Œåªæ˜¯ `key` ä» `keyspace` ä¸­æš‚æ—¶ç§»é™¤ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ°ä¸€ä¸ªå¼‚æ­¥é˜Ÿåˆ—ï¼Œæœ€åç”±åå°çº¿ç¨‹å»åˆ é™¤ã€‚ 

#### å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹

`I/O threading`

![redis-io-threading]({{ site.url }}/assets/imgs/resume/redis-io-threading.jpg)

- å¤šä¸ªçº¿ç¨‹ï¼ˆSub Reactorsï¼‰å„è‡ªç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯ï¼›
- ç”± Main Reactor è´Ÿè´£æ¥æ”¶æ–°è¿æ¥å¹¶åˆ†å‘ç»™ Sub Reactors å»ç‹¬ç«‹å¤„ç†ï¼›
- æœ€å Sub Reactors å›å†™å“åº”ç»™å®¢æˆ·ç«¯ã€‚

![redis-multi-thread]({{ site.url }}/assets/imgs/resume/redis-multi-thread.jpg)

- client å‘é€è¯·æ±‚ï¼Œè§¦å‘**è¯»å°±ç»ªäº‹ä»¶**ï¼Œä¸»çº¿ç¨‹ä¸ä¼šæ›²åº¦ client çš„å‘½ä»¤ï¼Œå°† `client` æ”¾å…¥ LIFO é˜Ÿåˆ— `clients_pending_read`ï¼›
- Event Loop ä¸­ï¼Œ`beforeSleep -->handleClientsWithPendingReadsUsingThreads`ï¼Œåˆ©ç”¨ Round-Robin è½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒæŠŠ `clients_pending_read` é˜Ÿåˆ—ä¸­çš„è¿æ¥å‡åŒ€åœ°åˆ†é…ç»™ I/O çº¿ç¨‹å„è‡ªçš„æœ¬åœ° FIFO ä»»åŠ¡é˜Ÿåˆ— `io_threads_list[id]` å’Œä¸»çº¿ç¨‹è‡ªå·±ï¼ŒI/O çº¿ç¨‹é€šè¿‡ socket è¯»å–å®¢æˆ·ç«¯çš„è¯·æ±‚å‘½ä»¤ï¼Œå­˜å…¥ client->querybuf å¹¶è§£æç¬¬ä¸€ä¸ªå‘½ä»¤ï¼Œä½†ä¸æ‰§è¡Œå‘½ä»¤ï¼Œä¸»çº¿ç¨‹å¿™è½®è¯¢ï¼Œç­‰å¾…æ‰€æœ‰ I/O çº¿ç¨‹å®Œæˆè¯»å–ä»»åŠ¡ï¼›
- ä¸»çº¿ç¨‹å’Œæ‰€æœ‰ I/O çº¿ç¨‹éƒ½å®Œæˆäº†è¯»å–ä»»åŠ¡ï¼Œä¸»çº¿ç¨‹ç»“æŸå¿™è½®è¯¢ï¼Œéå† `clients_pending_read` é˜Ÿåˆ—ï¼Œæ‰§è¡Œæ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥çš„è¯·æ±‚å‘½ä»¤ï¼Œå…ˆè°ƒç”¨ processCommandAndResetClient æ‰§è¡Œç¬¬ä¸€æ¡å·²ç»è§£æå¥½çš„å‘½ä»¤ï¼Œç„¶åè°ƒç”¨ processInputBuffer è§£æå¹¶æ‰§è¡Œå®¢æˆ·ç«¯è¿æ¥çš„æ‰€æœ‰å‘½ä»¤ï¼Œ...ï¼›

---

### Redis Pipeline

`RTT`: c -> s & s -> c

å®¢æˆ·ç«¯ä½¿ç”¨ `pipeline`ï¼ŒæœåŠ¡ç«¯è¢«å¼ºè¿«ä½¿ç”¨å†…å­˜ queue å“åº”ã€‚

> æœ€å¥½æ‰¹æ¬¡è®¾ç½®åˆç†çš„æ•°å­—ï¼Œ 10Kï¼Œè¯»å–å“åº”ï¼Œå†å‘ 10Kã€‚

- åªéœ€è¦ä¸€æ¬¡ RTT
- æå¤§æå‡äº†æ¯ç§’èƒ½å¤„ç†çš„æ“ä½œçš„æ•°é‡ã€‚ socket I/O è§’åº¦æ¥çœ‹æœåŠ¡ä¸€æ¡å‘½ä»¤æ¯”è¾ƒæ˜‚è´µï¼Œè°ƒç”¨ `read()` å’Œ `write()` ç³»ç»Ÿè°ƒç”¨ï¼Œ user -> kernel åˆ‡æ¢ã€‚

---

### TCP æœ€å¤šå¯å»ºç«‹å¤šå°‘ä¸ªè¿æ¥ï¼Ÿ
```
fs.file-maxï¼š å½“å‰ç³»ç»Ÿå¯æ‰“å¼€çš„æœ€å¤§æ•°é‡
fs.nr_openï¼š å½“å‰ç³»ç»Ÿå•ä¸ªè¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ•°é‡
nofileï¼š æ¯ä¸ªç”¨æˆ·çš„è¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ•°é‡
```

linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒåŒ…æ‹¬ socketã€‚æ‰€ä»¥æ¯å½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ª socket æ—¶å€™ï¼Œå†…æ ¸å®é™…ä¸Šéƒ½ä¼šåˆ›å»ºåŒ…æ‹¬ file åœ¨å†…çš„å‡ ä¸ªå†…æ ¸å¯¹è±¡ã€‚è¯¥è¿›ç¨‹å¦‚æœæ‰“å¼€äº†ä¸¤ä¸ª socketï¼Œé‚£ä¹ˆå®ƒçš„å†…æ ¸å¯¹è±¡ç»“æ„å¦‚ä¸‹å›¾ã€‚

![tcp-socket-file]({{ site.url }}/assets/imgs/resume/tcp-socket-file.jpg)

