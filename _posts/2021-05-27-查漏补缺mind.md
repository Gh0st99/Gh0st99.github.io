---
layout: post
title:  "æŸ¥æ¼è¡¥ç¼ºæ€ç»´å¯¼å›¾"
date:   2021-05-27 13:20:06 +0800
categories: é¢è¯•
---


# æŸ¥æ¼è¡¥ç¼º

## Java
![java]({{ site.url }}/assets/imgs/resume/java.svg)

---

## JVM

![jvm]({{ site.url }}/assets/imgs/resume/jvm.svg)


---

## MySQL


![mysql]({{ site.url }}/assets/imgs/resume/mysql.svg)


![explain]({{ site.url }}/assets/imgs/resume/explain.svg)

![extra]({{ site.url }}/assets/imgs/resume/extra.svg)

---

## Redis

![redis]({{ site.url }}/assets/imgs/resume/redis.svg)

---
## ES

![es]({{ site.url }}/assets/imgs/resume/es.svg)

---
## åˆ†å¸ƒå¼

![distributed]({{ site.url }}/assets/imgs/resume/distributed.svg)

---
## Linux
![linux]({{ site.url }}/assets/imgs/resume/linux.svg)

---

## ç½‘ç»œ
![network]({{ site.url }}/assets/imgs/resume/network.svg)

---

## Spring

![spring]({{ site.url }}/assets/imgs/resume/spring.svg)


---
---
### synchronized
#### åŸç†

`Synchronized` çš„è¯­ä¹‰åº•å±‚æ˜¯é€šè¿‡ä¸€ä¸ª `monitor` çš„å¯¹è±¡æ¥å®Œæˆï¼Œå…¶å® `wait/notify` ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº `monitor` å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨ `wait/notify` ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º **java.lang.IllegalMonitorStateException** çš„å¼‚å¸¸çš„åŸå› ã€‚

- monitorenter & monitorexit
- ACC_SYNCHRONIZED 

![sync-markword]({{ site.url }}/assets/imgs/resume/sync-markword.png)

æœºåˆ¶ä¸ `AQS` æ˜¯å¾ˆç›¸ä¼¼çš„ï¼Œåªä¸è¿‡ `AQS` ä¸­æ˜¯ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å¤šä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚

![sync-flow]({{ site.url }}/assets/imgs/resume/sync-flow.png)

##### ç»“æ„
```c++
ObjectMonitor() {
    _header       = NULL;
    _count        = 0;
    _waiters      = 0,       // ç­‰å¾…ä¸­çš„çº¿ç¨‹æ•°
    _recursions   = 0;       // çº¿ç¨‹é‡å…¥æ¬¡æ•°
    _object       = NULL;    // å­˜å‚¨è¯¥ monitor çš„å¯¹è±¡
    _owner        = NULL;    // æŒ‡å‘æ‹¥æœ‰è¯¥ monitor çš„çº¿ç¨‹
    _WaitSet      = NULL;    // ç­‰å¾…çº¿ç¨‹ åŒå‘å¾ªç¯é“¾è¡¨_WaitSet æŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    _WaitSetLock  = 0 ;
    _Responsible  = NULL ;
    _succ         = NULL ;
    _cxq          = NULL ;   // å¤šçº¿ç¨‹ç«äº‰é”æ—¶çš„å•å‘é“¾è¡¨
    FreeNext      = NULL ;
    _EntryList    = NULL ;   // _owner ä»è¯¥åŒå‘å¾ªç¯é“¾è¡¨ä¸­å”¤é†’çº¿ç¨‹ï¼Œ
    _SpinFreq     = 0 ;
    _SpinClock    = 0 ;
    OwnerIsThread = 0 ;
    _previous_owner_tid = 0; // å‰ä¸€ä¸ªæ‹¥æœ‰æ­¤ç›‘è§†å™¨çš„çº¿ç¨‹ ID
  }
```
- `_owner`ï¼šåˆå§‹æ—¶ä¸º `NULL`ã€‚å½“æœ‰çº¿ç¨‹å æœ‰è¯¥ `monitor` æ—¶ `owner` æ ‡è®°ä¸ºè¯¥çº¿ç¨‹çš„ `ID`ã€‚å½“çº¿ç¨‹é‡Šæ”¾ `monitor` æ—¶ `owner` æ¢å¤ä¸º `NULL`ã€‚`owner` æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æº `JVM` æ˜¯é€šè¿‡ `CAS` æ“ä½œæ¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨çš„ã€‚
- `_cxq`ï¼šç«äº‰é˜Ÿåˆ—æ‰€æœ‰è¯·æ±‚é”çš„çº¿ç¨‹é¦–å…ˆä¼šè¢«æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼ˆå•å‘ï¼‰ã€‚`_cxq` æ˜¯ä¸€ä¸ªä¸´ç•Œèµ„æº `JVM` é€šè¿‡ `CAS` åŸå­æŒ‡ä»¤æ¥ä¿®æ”¹ `_cxq` é˜Ÿåˆ—ã€‚
    - æ¯å½“æœ‰æ–°æ¥çš„èŠ‚ç‚¹å…¥é˜Ÿï¼Œå®ƒçš„ `next` æŒ‡é’ˆæ€»æ˜¯æŒ‡å‘ä¹‹å‰é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œè€Œ `_cxq` æŒ‡é’ˆä¼šæŒ‡å‘è¯¥æ–°å…¥é˜Ÿçš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ˜¯åæ¥å±…ä¸Šã€‚
- `_EntryList`ï¼š `_cxq` é˜Ÿåˆ—ä¸­**æœ‰èµ„æ ¼æˆä¸ºå€™é€‰èµ„æºçš„çº¿ç¨‹**ä¼šè¢«ç§»åŠ¨åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚
- `_WaitSet`: ç­‰å¾…é˜Ÿåˆ—å› ä¸ºè°ƒç”¨ `wait` æ–¹æ³•è€Œ**è¢«é˜»å¡**çš„çº¿ç¨‹ä¼šè¢«æ”¾åœ¨è¯¥é˜Ÿåˆ—ä¸­ã€‚

##### ç«äº‰

- é€šè¿‡ `CAS` å°è¯•æŠŠ `monitor` çš„ `owner` å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚
- å¦‚æœè®¾ç½®ä¹‹å‰çš„ `owner` **æŒ‡å‘å½“å‰çº¿ç¨‹**ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹**å†æ¬¡è¿›å…¥** `monitor`ï¼Œå³é‡å…¥é”æ‰§è¡Œ `recursions++` , è®°å½•é‡å…¥çš„æ¬¡æ•°ã€‚(**å¯é‡å…¥æ€§**)
- å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¯¥ `monitor`, è®¾ç½® `recursions` ä¸º 1, `_owner` ä¸º**å½“å‰çº¿ç¨‹**ï¼Œè¯¥çº¿ç¨‹æˆåŠŸè·å¾—é”å¹¶è¿”å›ã€‚
- å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™**ç­‰å¾…**é”çš„é‡Šæ”¾ã€‚

##### ç­‰å¾…

- å½“å‰çº¿ç¨‹è¢«å°è£…æˆ `ObjectWaiter` å¯¹è±¡ `node`ï¼ŒçŠ¶æ€è®¾ç½®æˆ `ObjectWaiter::TS_CXQã€‚
- `for` å¾ªç¯é€šè¿‡ `CAS` æŠŠ `node` èŠ‚ç‚¹ push åˆ° `_cxq` åˆ—è¡¨ä¸­ï¼ŒåŒä¸€æ—¶åˆ»å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹æŠŠè‡ªå·±çš„ `node` èŠ‚ç‚¹ push åˆ° `_cxq` åˆ—è¡¨ä¸­ã€‚
- `node` èŠ‚ç‚¹ push åˆ° `_cxq` åˆ—è¡¨ä¹‹åï¼Œé€šè¿‡**è‡ªæ—‹**å°è¯•è·å–é”ï¼Œå¦‚æœè¿˜æ˜¯**æ²¡æœ‰è·å–åˆ°é”**åˆ™é€šè¿‡ `park` å°†å½“å‰çº¿ç¨‹**æŒ‚èµ·ç­‰å¾…è¢«å”¤é†’**ã€‚
- å½“è¯¥çº¿ç¨‹**è¢«å”¤é†’**æ—¶ä¼šä»æŒ‚èµ·çš„ç‚¹ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡ `ObjectMonitor::TryLock` **å°è¯•è·å–é”**ã€‚

##### é‡Šæ”¾

å½“æŸä¸ªæŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œä¼š**é‡Šæ”¾é”**å¹¶ `unpark` **åç»­çº¿ç¨‹**ã€‚

##### notify

`notify` æˆ–è€… `notifyAll` æ–¹æ³•å¯ä»¥**å”¤é†’åŒä¸€ä¸ªé”ç›‘è§†å™¨ä¸‹è°ƒç”¨ wait æŒ‚èµ·çš„çº¿ç¨‹**ï¼Œå°†å…¶æ”¾å…¥ `_EntryList`ã€‚


---

### çº¿ç¨‹æ± 

#### çº¿ç¨‹è·å–ä»»åŠ¡

`getTask()`

![threadpool-gettask]({{ site.url }}/assets/imgs/resume/threadpool-gettask.jpg)

èµ°ğŸ‘ˆğŸ»çš„æ˜¯ä¸å¯å›æ”¶çš„æ ¸å¿ƒçº¿ç¨‹ï¼Œèµ°ğŸ‘‰ğŸ»çš„æ˜¯é™ keepalive æ—¶é—´ï¼Œéæ ¸å¿ƒçº¿ç¨‹ + å¯å›æ”¶çš„æ ¸å¿ƒçº¿ç¨‹ã€‚

å¦‚æœè¿”å›çš„æ˜¯ `null`ï¼Œåˆ™å°† `ctl` cas(-1)ã€‚

è°ƒç”¨ `processWorkerExit` æ¸…ç†çº¿ç¨‹ã€‚

è·å–ä»»åŠ¡ä¸ä¸º nullï¼Œä¼šä¸Šè‡ªå·±çš„ä¸€æŠŠé”æ‰§è¡Œä»»åŠ¡ã€‚

#### å‚æ•°åŠ¨æ€åŒ–

##### setCorePoolSize

![threadpool-setcoresize]({{ site.url }}/assets/imgs/resume/threadpool-setcoresize.jpg)

##### setKeepAliveTime

å¦‚æœæ—¶é—´æ”¹å°ï¼Œåˆ™ `interruptIdleWorkers`ã€‚

```java
final ReentrantLock mainLock = this.mainLock;
mainLock.lock();
try {
    for (Worker w : workers) {
        Thread t = w.thread;
        // å°è¯•è·å¾—é”æˆåŠŸï¼Œåˆ™è¡¨æ˜å…¶ç©ºé—²
        if (!t.isInterrupted() && w.tryLock()) {
            try {
                t.interrupt();
            } catch (SecurityException ignore) {
            } finally {
                w.unlock();
            }
        }
        if (onlyOne)
            break;
    }
} finally {
    mainLock.unlock();
}
```

##### setMaximumPoolSize

`interruptIdleWorkers`ã€‚

#### å¼‚å¸¸å¤„ç†

##### submit

```java
public Future<?> submit(Runnable task) {
    if (task == null) throw new NullPointerException();
    RunnableFuture<Void> ftask = newTaskFor(task, null);
    execute(ftask);
    return ftask;
}

protected <T> RunnableFuture<T> newTaskFor(Callable<T> callable) {
    return new FutureTask<T>(callable);
}

// FutureTask::run
public void run() {
    // ...
    try {
        Callable<V> c = callable;
        if (c != null && state == NEW) {
            V result;
            boolean ran;
            try {
                result = c.call();
                ran = true;
            } catch (Throwable ex) {
                result = null;
                ran = false;
                // ç”Ÿåäº†å¼‚å¸¸
                setException(ex);
            }
            if (ran)
                set(result);
        }
    } finally {
        // ...
    }
}
// FutureTask::setException
protected void setException(Throwable t) {
    if (STATE.compareAndSet(this, NEW, COMPLETING)) {
        // å°†å¼‚å¸¸è®¾ç½®ä¸ºç»“æœ
        outcome = t;
        STATE.setRelease(this, EXCEPTIONAL); // final state
        finishCompletion();
    }
}

private V report(int s) throws ExecutionException {
    Object x = outcome;
    if (s == NORMAL)
        return (V)x;
    if (s >= CANCELLED)
        throw new CancellationException();
    // æŠ›å‡ºå¼‚å¸¸
    throw new ExecutionException((Throwable)x);
}

public V get() throws InterruptedException, ExecutionException {
    int s = state;
    if (s <= COMPLETING)
        s = awaitDone(false, 0L);
    // è·å¾—ç»“æœ
    return report(s);
}
```

åªæœ‰åœ¨ `get()` æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚


##### execute

ä»»åŠ¡éƒ½æ˜¯ç”± `Worker` æ‰§è¡Œã€‚

```java
private final class Worker extends AbstractQueuedSynchronizer implements Runnable {
    public void run() {
        runWorker(this);
    }

    final void runWorker(Worker w) {
        Thread wt = Thread.currentThread();
        Runnable task = w.firstTask;
        w.firstTask = null;
        w.unlock(); // allow interrupts
        boolean completedAbruptly = true;
        try {
            while (task != null || (task = getTask()) != null) {
                w.lock();
                // If pool is stopping, ensure thread is interrupted;
                // if not, ensure thread is not interrupted.  This
                // requires a recheck in second case to deal with
                // shutdownNow race while clearing interrupt
                if ((runStateAtLeast(ctl.get(), STOP) ||
                     (Thread.interrupted() &&
                      runStateAtLeast(ctl.get(), STOP))) &&
                    !wt.isInterrupted())
                    wt.interrupt();
                try {
                    beforeExecute(wt, task);
                    try {
                        task.run();
                        afterExecute(task, null);
                    } catch (Throwable ex) {
                        // é‡åˆ°å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸
                        afterExecute(task, ex);
                        throw ex;
                    }
                } finally {
                    task = null;
                    w.completedTasks++;
                    w.unlock();
                }
            }
            completedAbruptly = false;
        } finally {
            processWorkerExit(w, completedAbruptly);
        }
    }
}
```
---

### Redis Cluster

- `6379` æœåŠ¡å®¢æˆ·ç«¯ï¼›
- `16379` cluster busï¼ŒèŠ‚ç‚¹é—´é€šä¿¡çš„äºŒè¿›åˆ¶é€šé“ï¼›
  - æ•…éšœæ£€æµ‹
  - é…ç½®æ›´æ–°
  - æ•…éšœè½¬ç§»æˆæƒ

ä¸ä½¿ç”¨ä¸€è‡´æ€§ hashï¼Œä½¿ç”¨ `hash slot`ã€‚æœ‰ `16384 slot`ï¼Œ`CRC16(key) mod 16384` æ¥åˆ†é…ã€‚e.g.

- Node A contains hash slots from 0 to 5500.
- Node B contains hash slots from 5501 to 11000.
- Node C contains hash slots from 11001 to 16383.

å¢åˆ èŠ‚ç‚¹ï¼š
- å‡å¦‚è¦ + Dï¼Œå°±æŠŠ Aï¼ŒBï¼ŒC ä¸­çš„ä¸€äº› `hash slot`
- å‡å¦‚è¦ - Aï¼Œå°±æŠŠ A ä¸­çš„ `hash slot` ç§»åŠ¨å•ŠBï¼ŒC ä¸­

**hash tag**

`this{foo}` å’Œ `another{foo}` åœ¨ä¸€ä¸ª `hash slot` ä¸­ï¼Œå¯ä»¥åœ¨ä¸€æ¡å‘½ä»¤ä¸­æ‰§è¡Œå¤šé”®æ“ä½œã€‚

**master slave**

`A` & `B` & `C` æ¯ä¸ªå¢åŠ ä¸€ä¸ª `slave` èŠ‚ç‚¹ã€‚

`B` GG åï¼Œ `B1` è¢«é€‰ä¸¾æ–°çš„ `master`ã€‚

**ä¸€è‡´æ€§ä¿è¯**

ç‰¹å®šæƒ…å†µä¸‹ï¼Œå¯èƒ½å›ä¸¢å¤±ç³»ç»Ÿå‘å®¢æˆ·ç«¯ç¡®è®¤çš„å†™å…¥ã€‚

åŸå› æ˜¯ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼š
- å®¢æˆ·ç«¯å†™å…¥ master B;
- master B å›å¤ OK;
- master B ä¼ æ’­å†™åˆ° B1, B2, B3ã€‚

ä¸¢å¤±æ•°æ®å¯èƒ½ï¼š
1. å‡å¦‚ï¼Œmaster B å›å¤åï¼Œ gg äº†ï¼Œè¿˜æ²¡æ¥å¾—åŠä¼ æ’­ï¼ŒB1 å½“é€‰ï¼Œå°±ä¸¢å¤±äº†å†™æ•°æ®ã€‚

> å¦‚åŒå…¶ä»–æ•°æ®åº“ï¼Œæ¯ s åŒæ­¥åˆ°ç¡¬ç›˜ä¸€æ ·ã€‚å¯å¼ºåˆ¶åŒæ­¥å¤åˆ¶ã€å†™(**WAIT**)ï¼Œä½†æ˜¯å›é™ä½æ€§èƒ½ã€‚å³ä½¿åŒæ­¥å†™ä¹Ÿä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§ã€‚

2.  ç½‘ç»œåˆ†åŒºï¼ŒB å’Œ å®¢æˆ·ç«¯ Z1 ä¸å…¶ä»–åˆ†åŒºäº†ã€‚Z1 èƒ½å†™å…¥ Bã€‚å¦‚æœåˆ†åŒºæŒç»­è¶³å¤Ÿä¹…æ—¶é—´è®© B1 åœ¨åˆ†åŒºçš„å¤šæ•°ä¾§æå‡ä¸º masterï¼Œåˆ™ Z1 åŒæ—¶å‘é€ç»™ B çš„å†™å…¥å°†ä¸¢å¤±ã€‚

> **node timeout**: Z1 èƒ½å¤Ÿå‘é€åˆ° B çš„å†™å…¥é‡æœ‰ä¸€ä¸ª max windowï¼šå¦‚æœåˆ†åŒºçš„å¤šæ•°ä¾§å·²ç»æœ‰è¶³å¤Ÿçš„æ—¶é—´æ¥é€‰ä¸¾ä¸€ä¸ª slaveä½œä¸º masterï¼Œé‚£ä¹ˆå°‘æ•°ä¾§çš„æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½å°†åœæ­¢æ¥å—å†™å…¥


#### å®¹é”™æ€§

##### å¿ƒè·³å’Œ gossip æ¶ˆæ¯

heartbeat:
- ping
- pong
- ä¸¤ä¸ªéƒ½åŒ…å«é‡è¦çš„é…ç½®ä¿¡æ¯

gossip æ¶ˆæ¯ï¼š
- 

---

### TCP æœ€å¤šå¯å»ºç«‹å¤šå°‘ä¸ªè¿æ¥ï¼Ÿ
```
fs.file-maxï¼š å½“å‰ç³»ç»Ÿå¯æ‰“å¼€çš„æœ€å¤§æ•°é‡
fs.nr_openï¼š å½“å‰ç³»ç»Ÿå•ä¸ªè¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ•°é‡
nofileï¼š æ¯ä¸ªç”¨æˆ·çš„è¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ•°é‡
```

linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒåŒ…æ‹¬ socketã€‚æ‰€ä»¥æ¯å½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ª socket æ—¶å€™ï¼Œå†…æ ¸å®é™…ä¸Šéƒ½ä¼šåˆ›å»ºåŒ…æ‹¬ file åœ¨å†…çš„å‡ ä¸ªå†…æ ¸å¯¹è±¡ã€‚è¯¥è¿›ç¨‹å¦‚æœæ‰“å¼€äº†ä¸¤ä¸ª socketï¼Œé‚£ä¹ˆå®ƒçš„å†…æ ¸å¯¹è±¡ç»“æ„å¦‚ä¸‹å›¾ã€‚

![tcp-socket-file]({{ site.url }}/assets/imgs/resume/tcp-socket-file.jpg)

